#include <SoftwareSerial.h>
#include "Arduino.h"
SoftwareSerial esp8266(2, 3); // RX, TX



void setup() {

  Serial.begin(9600);   
  esp8266.begin(115200);  

  Serial.println("ESP8266 ile haberlesme basladi");

  esp8266.println("AT+RST");
  delay(5000);
  esp8266.println("AT+CWMODE=3");
  delay(1000);
  esp8266.println("AT+CIPMUX=1");
  delay(1000);
  esp8266.println("AT+CWJAP=\"FiberHGW_ZT2T3R_2.4GHz\",\"HDA3dxXHfq\"");
  delay(10000);
  esp8266.println("AT+CIPSERVER=1,80");

  delay(3000);
  //esp8266.println("AT+CIPSTART=AT+CIPSTART=\"TCP\",\"192.168.1.33\",80");
  Serial.println("Sunucu baslatildi.Wifi agina baglanildi");
  
}

void loop() {
    
  if (Serial.available()) {
    // Seri bağlantıdan veri oku
    String data = Serial.readStringUntil('\n');

    // HTTP POST isteği için veriyi hazırla
    Serial.println("Veri alindi hazirlaniyor...");
    String httpRequest = "POST /endpoint HTTP/1.1\r\n";
    httpRequest += "Host: 192.168.1.33\r\n";
    httpRequest += "Content-Length: " + String(data.length()) + "\r\n";
    httpRequest += "Content-Type: text/plain\r\n\r\n";
    httpRequest += data + "\r\n";
    Serial.print("Veri hazir. Gonderilecek veri = ");
    Serial.println(httpRequest);

    // ESP8266 üzerinden sunucuya POST isteği gönder
    
    esp8266.println("AT+CIPSTART=\"TCP\",\"192.168.1.33\",81");
    Serial.println("ESP sunucu arasinda baglanti kuruldu.");
    delay(5000);
    esp8266.println("AT+CIPSEND=" + String(httpRequest.length()));
    esp8266.print(httpRequest);
    Serial.println("ESPden sunucya data gonderildi");
    delay(2000);
    Serial.println("Veri gonderildi");
   // delay(1000);
   // esp8266.println("AT+CIPCLOSE");
   // delay(5000);
   // Serial.println("Istemci kapandi. Sunucu moduna gecildi");
    delay(5000);
    // Sunucudan gelen yanıtı oku ve seri bağlantıya yazdır
    while(esp8266.available()) {
      Serial.println("Istemciden cevap geldi:");
      String line = esp8266.readStringUntil('\n');
      Serial.println(line);
    }

    //
  }
}


void myDelay(unsigned long delayTime) {
    unsigned long startTime = micros();
    while (micros() - startTime < delayTime * 1000) {
        // Bu döngü, belirtilen süre (milisaniye cinsinden) geçene kadar dönmeye devam eder
    }
}